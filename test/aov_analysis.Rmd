---
title: "Intrauterine"
author: "Jianjian Cui, Dongdong Kong"
date: "2019/4/27"
output:
  html_document:
    df_print: paged
  pdf_document:
    fig_height: 4
    fig_width: 9
    includes:
      header-includes: \usepackage{xeCJK}
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
  word_document: default
CJKmainfont: Microsoft YaHei
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "R> ")

# MAIN FUNCTIONS
to_factor <- function(x){
    factor(1*x)
}

par_setting <- function(){
    par(mar = c(2, 13, 2, 1), mgp = c(3, 0.9, 0))
}

label_fun <- function(x, include.sd=FALSE){
    md <- median(x, na.rm = T)
    sd <- sd(x, na.rm = T)

    r <- data.frame(y = md, sd = sd)
    r$label <- ifelse(include.sd, sprintf("%.1f +- %.1f", md, sd), sprintf("%.1f", md)) 
    r
}

#' @export
label_sd <- function(x){
    label_fun(x, include.sd = TRUE)
}

#' @export
label_median <- function(x){
    label_fun(x, include.sd = FALSE)
}

```

# Materials

```{r cars, echo = TRUE}
source("test/main_pkgs.R")
const = TRUE
df <- read_excel("data/产科胎膜早破.xls")[, -3] %>% data.table()
df[, `:=`(ill_intrauterine = grepl("胎膜炎", detail) %>% 
              factor(levels = c("TRUE", "FALSE"), 
                     labels = c("IU", "non_IU")),
       ill_gdm = grepl("糖尿病", detail)  %>% 
           factor(levels = c("TRUE", "FALSE"), labels = c("GDM", "non_GDM")),
       pre_labour = grepl("早产", detail)  %>% to_factor())]

df[, `:=`(age = gsub("Y", "", age) %>% as.numeric(), 
          detail = NULL)]
# df[is.na(weight), .N]
knitr::kable(head(df))
```

# Results
## Whether intrauterine and gdm is independent?

```{r pressure, echo = FALSE}
chisq <- function(df){
    tbl <- table(df[, .(ill_intrauterine, ill_gdm)])
    print(tbl)    

    cat('The probability of intrauterine (%)', sep="\n")
    print(tbl[1, ]/colSums(tbl)*100)

    cat('1. chisq.test', sep="\n")
    chisq.test(tbl) %>% print()

    cat('2.1 age difference of GDM and intrauterine patients', sep="\n")
    m_lm  <- lm(age~ill_gdm*ill_intrauterine, df)
    m_aov <- aov(m_lm)

    s <- TukeyHSD(m_aov)
    s %>% print()
    # par_setting()
    # plot(s, las = 1)

    cat('2.2 Visualization of age difference', sep="\n")
    d <- df#[ill_intrauterine == "IU" | ill_gdm == "GDM"]
    d[, x:= sprintf("%s-%s", ill_intrauterine, ill_gdm)]
    p <- ggplot(d, aes(x, age, fill = x)) + 
        stat_boxplot(geom ='errorbar', width = 0.5)+
        geom_boxplot() + 
        stat_summary(fun.data = label_median, colour = "black", size = 6, geom = "text", vjust = -0.5) + 
        theme(legend.position = "none")
    print(p)
}
```

\pagebreak

## 总样本
```{r, echo=FALSE}
chisq(df)
```

> 由结果可知，从non-GDM到GDM，intrauterine的发病率从3.27%上升到4.57%。
> 且卡方检验显示，GDM与intrauterine非相互独立，p-value=0.058，在0.1水平下显著。

如图所示，无论是GDM还是IU，高龄产妇的发病率更高。

\pagebreak

## `早产`样本
```{r, echo=FALSE}
d <- df[pre_labour == "1", ]
chisq(d)
```

\pagebreak

## `非早产`样本
```{r, echo=FALSE}
d <- df[pre_labour == "0", ]
chisq(d)
```
